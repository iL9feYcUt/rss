# RSS PWA — iPhone向け更新通知サイト（雛形）

このリポジトリは、監視するサイトの更新を検知してPWA経由で通知するための雛形です。

概要:
- フロントエンド: PWA（Service Worker） + 監視サイト追加UI（CSSセレクタで抽出をプレビュー）
- バックエンド: Supabase Edge FunctionでHTMLを取得・解析
- 自動化: GitHub Actionsで定期スクレイプ→Supabaseへ通知

セットアップ（ローカル）:
1. Node と npm をインストール
2. ルートで `npm install` を実行
3. `README` の `SUPABASE_*` 環境変数を用意し、Edge FunctionをSupabaseにデプロイ
4. `npm run dev` でフロントを起動

SupabaseとGitHub Actionsの設定手順はソース内コメントを参照してください。

前提: Node、npm、Supabaseプロジェクト（無料枠で可）、GitHubリポジトリ

1) ローカルでのフロント起動

```bash
npm install
npm run dev
```

2) Supabase側の準備

- Supabaseでプロジェクトを作成し、Postgresに以下のテーブルを作成します（SQL例）:

```sql
create table articles (
	id bigint generated by default as identity primary key,
	title text,
	link text,
	date text,
	published_at timestamptz,
	created_at timestamptz default now()
);
-- 推奨: link に UNIQUE 制約を付ける（重複防止）
alter table articles add constraint unique_link unique (link);
```

- Supabase Edge Functions を使う場合: `supabase/functions` にある `fetch_and_parse` をデプロイします。
	- ローカルからデプロイするには `supabase` CLI を使います（https://supabase.com/docs/guides/functions）。
	- Edge Function は HTML を取得して `items`（title/link/date）を返します。ローカルで動作確認するには `supabase functions serve fetch_and_parse` を参照ください。

3) GitHub Actions と Secrets

- リポジトリに以下の Secrets を設定してください:
	- `SUPABASE_FUNCTION_URL` : 例 `https://<project>.functions.supabase.co`
	- `SUPABASE_FUNCTION_KEY` : 関数の呼び出しに使うキー（または anon key）
	- `SUPABASE_URL` : 例 `https://<project>.supabase.co`
	- `SUPABASE_SERVICE_ROLE_KEY` : サーバー側操作用の Service Role Key（機密）

- ワークフローの動作:
	- `.github/workflows/scrape.yml` は定期的に Edge Function を呼び、取得した `items` を `articles` テーブルに POST します。
	- `Prefer: resolution=merge-duplicates` を使って重複を回避（`link` に UNIQUE 制約を付けることを推奨）。

4) フロントエンドから記事一覧を表示

- 環境変数（Vite）を設定して、`VITE_SUPABASE_URL` と `VITE_SUPABASE_ANON_KEY` を用意します。`.env` に書く例:

```
VITE_SUPABASE_URL=https://<project>.supabase.co
VITE_SUPABASE_ANON_KEY=<anon-public-key>
```

- フロントは `src/supabaseClient.js` で `supabase-js` を使って `articles` テーブルを参照します。

6) プッシュ通知のセットアップ

- VAPID キーを生成（ローカルで生成して Supabase の Edge Function に環境変数として設定）:

```bash
npm install -g web-push
web-push generate-vapid-keys --json
```

- 生成した `publicKey` をフロントの `.env` に `VITE_VAPID_PUBLIC_KEY` として保存し、`privateKey` と `publicKey` を Supabase Edge Function の環境変数 `VAPID_PRIVATE_KEY` / `VAPID_PUBLIC_KEY` に設定してください。

- Supabase に push 購読情報を格納するテーブル例:

```sql
create table push_subscriptions (
	id bigint generated by default as identity primary key,
	endpoint text unique,
	keys jsonb,
	subscription jsonb,
	created_at timestamptz default now()
);
```

- フロントでは `src/App.jsx` の「プッシュ購読」ボタンで購読し、`push_subscriptions` に保存します。`send_push` Edge Function をデプロイしておくと、管理側・Actions・サーバーから通知送信できます。

5) 通知（Push）について

- Web Push を使う場合、ブラウザ側で Push Subscription を取得して Supabase に保存し、サーバー側で購読情報に対して Push を送る実装が必要です。
- 本テンプレートではまず「記事を取得して DB に保存する」までを自動化しています。Push通知の実装は次ステップで追加可能です。

---

トラブルシュートのヒント:
- Edge Function の CORS の問題がある場合、`fetch_and_parse` が OPTIONS に対応しているか確認してください（このリポジトリの関数は CORS を付与済みです）。
- GitHub Actions のランナーから Supabase REST に POST するには `SUPABASE_SERVICE_ROLE_KEY` を Secrets に入れてください（危険なキーなので注意）。

SupabaseとGitHub Actionsの設定手順はソース内コメントを参照してください。
